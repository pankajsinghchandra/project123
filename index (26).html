<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Progress Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #e0e7ff 0%, #e9d5ff 100%);
        }
        .badge { padding: 0.5rem 1rem; border-radius: 9999px; color: white; transition: all 0.3s ease; }
        .badge-at-risk { background-color: #ef4444; }
        .badge-not-started { background-color: #6b7280; }
        .badge-needs-improvement { background-color: #f97316; }
        .badge-practicing { background-color: #eab308; }
        .badge-satisfactory { background-color: #22c55e; }
        .badge-mastered { background-color: #3b82f6; }
        .progress-circle { position: relative; width: 60px; height: 60px; }
        .progress-circle svg { transform: rotate(-90deg); }
        .progress-circle .circle-bg { fill: none; stroke: #e5e7eb; stroke-width: 5; }
        .progress-circle .circle { fill: none; stroke: #3b82f6; stroke-width: 5; stroke-linecap: round; }
        .progress-circle .percentage { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 16px; font-weight: bold; }
        .subject-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .subject-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 5% auto; padding: 20px; width: 90%; max-width: 896px; border-radius: 8px; max-height: 80vh; overflow-y: auto; }
        .close-modal { float: right; font-size: 24px; cursor: pointer; }
        .at-risk { border: 2px solid #ef4444; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        /* Top Navigation Bar Styles */
        #top-nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #1e3a8a;
            color: white;
            z-index: 900;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #top-nav ul {
            display: flex;
            justify-content: center;
            margin: 0;
            padding: 0;
            list-style: none;
        }
        #top-nav li {
            padding: 1rem 2rem;
            transition: background-color 0.3s ease;
        }
        #top-nav li:hover {
            background-color: #2b52b6;
            cursor: pointer;
        }
        #top-nav li i {
            margin-right: 0.5rem;
        }
        #dashboard-content {
            padding-top: 60px; /* Ensure content doesn't overlap with fixed nav */
        }
        @media (max-width: 640px) {
            #top-nav ul {
                flex-direction: column;
                align-items: center;
            }
            #top-nav li {
                padding: 0.75rem 1rem;
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body class="font-sans">
    <!-- Login Page -->
    <div id="login-page" class="container mx-auto p-6 flex items-center justify-center h-screen">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-center text-indigo-600"><i class="fas fa-lock mr-2"></i>Login</h2>
            <div class="mb-4">
                <label for="school-name" class="block text-sm font-medium">School Name</label>
                <select id="school-name" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <option value="" disabled selected>Select School</option>
                </select>
                <p id="school-name-error" class="text-red-500 text-sm mt-1 hidden">Please select a school.</p>
            </div>
            <div class="mb-4">
                <label for="username" class="block text-sm font-medium">Username</label>
                <input id="username" type="text" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Enter username">
            </div>
            <div class="mb-4">
                <label for="password" class="block text-sm font-medium">Password</label>
                <input id="password" type="password" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Enter password">
            </div>
            <button id="login-btn" class="w-full bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 transition duration-300">Login</button>
            <p id="login-error" class="text-red-500 text-center mt-4 hidden">Invalid credentials</p>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Top Navigation Bar for Admins -->
        <nav id="top-nav" class="hidden">
            <ul>
                <li id="school-management-nav"><i class="fas fa-school"></i>School Management</li>
                <li id="teacher-management-nav"><i class="fas fa-user-cog"></i>Teacher Management</li>
            </ul>
        </nav>

        <div id="dashboard-content" class="container mx-auto p-6">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-indigo-700"><i class="fas fa-chalkboard-teacher mr-2"></i>Student Progress Tracker</h1>
                <div class="space-x-2">
                    <button id="switch-school-btn" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition duration-300">Switch School</button>
                    <button id="export-data-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-300 hidden">Export Data</button>
                    <label for="import-data-input" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-300 cursor-pointer inline-block hidden" id="import-data-btn">Import Data</label>
                    <input type="file" id="import-data-input" accept=".json" class="hidden">
                    <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-300">Logout</button>
                </div>
            </div>

            <!-- Welcome Message for Admin -->
            <div id="welcome-message" class="hidden bg-blue-100 p-4 rounded-lg mb-6 text-blue-800">
                <p>Welcome, Admin! It looks like there are no schools yet. Please go to <strong>School Management</strong> to add a school.</p>
            </div>

            <!-- Admin School Management -->
            <div id="admin-school-management" class="hidden">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-600"><i class="fas fa-school mr-2"></i>School Management</h2>
                <div class="bg-white p-6 rounded-lg shadow-lg mb-4">
                    <h3 class="text-xl font-medium mb-4">Add School</h3>
                    <div class="grid grid-cols-1 gap-4">
                        <input id="new-school-name" type="text" placeholder="School Name" class="p-2 border rounded-lg">
                    </div>
                    <button id="add-school-btn" class="mt-4 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">Add School</button>
                </div>
                <div id="school-list" class="bg-white p-6 rounded-lg shadow-lg"></div>
            </div>

            <!-- Admin Teacher Management -->
            <div id="admin-teacher-management" class="hidden">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-600"><i class="fas fa-user-cog mr-2"></i>Teacher Management</h2>
                <div class="bg-white p-6 rounded-lg shadow-lg mb-4">
                    <h3 class="text-xl font-medium mb-4">Add Teacher</h3>
                    <div class="mb-4">
                        <label for="teacher-school-select" class="block text-sm font-medium">Select School</label>
                        <select id="teacher-school-select" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="" disabled selected>Select School</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input id="teacher-username" type="text" placeholder="Teacher Username" class="p-2 border rounded-lg">
                        <input id="teacher-password" type="password" placeholder="Teacher Password" class="p-2 border rounded-lg">
                    </div>
                    <button id="add-teacher-btn" class="mt-4 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">Add Teacher</button>
                </div>
                <div id="teacher-list" class="bg-white p-6 rounded-lg shadow-lg"></div>
            </div>

            <!-- Teacher Dashboard -->
            <div id="teacher-dashboard" class="hidden">
                <!-- Student Management -->
                <div class="mb-8">
                    <h2 class="text-2xl font-semibold mb-4 text-indigo-600"><i class="fas fa-users mr-2"></i>Manage Students</h2>
                    <div class="bg-white p-6 rounded-lg shadow-lg mb-4">
                        <h3 class="text-xl font-medium mb-4">Add Student</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <input id="student-name" type="text" placeholder="Student Name" class="p-2 border rounded-lg">
                            <input id="student-roll" type="text" placeholder="Roll Number" class="p-2 border rounded-lg">
                            <select id="student-class" class="p-2 border rounded-lg">
                                <option value="" disabled selected>Select Class</option>
                                <option value="1">Class 1</option>
                                <option value="2">Class 2</option>
                                <option value="3">Class 3</option>
                                <option value="4">Class 4</option>
                                <option value="5">Class 5</option>
                            </select>
                            <input id="student-photo" type="file" accept="image/*" class="p-2 border rounded-lg">
                        </div>
                        <button id="add-student-btn" class="mt-4 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">Add Student</button>
                    </div>
                </div>

                <!-- Class Selection -->
                <div class="mb-8">
                    <h2 class="text-2xl font-semibold mb-4 text-indigo-600"><i class="fas fa-school mr-2"></i>Select Class</h2>
                    <select id="class-select" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="" disabled selected>Select a class</option>
                        <option value="1">Class 1</option>
                        <option value="2">Class 2</option>
                        <option value="3">Class 3</option>
                        <option value="4">Class 4</option>
                        <option value="5">Class 5</option>
                    </select>
                </div>

                <!-- Student List -->
                <div id="student-list" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8"></div>

                <!-- Progress Chart -->
                <div id="progress-chart" class="bg-white p-6 rounded-lg shadow-lg mb-6">
                    <h3 class="text-xl font-medium mb-4 text-indigo-600">Class Progress Chart</h3>
                    <canvas id="progressChartCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Progress Modal -->
    <div id="student-progress-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">×</span>
            <h2 id="modal-student-name" class="text-2xl font-bold mb-4 text-indigo-600"></h2>
            <button id="update-student-progress-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 mb-4">Update Progress</button>
            <div id="update-history" class="mb-4"></div>
            <div id="modal-subjects-container" class="space-y-6"></div>
            <div class="bg-white p-6 rounded-lg shadow-lg mt-6">
                <h3 class="text-xl font-medium mb-4 text-indigo-600">Student Progress Chart</h3>
                <canvas id="studentProgressChartCanvas"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Initialize school-specific variables
        let currentSchool = localStorage.getItem("currentSchool") || "";
        let currentRole = "";
        const adminCredentials = { username: "admin", password: "admin123" };

        // Initialize school access list if not exists
        if (!localStorage.getItem("schoolAccessList")) {
            localStorage.setItem("schoolAccessList", JSON.stringify({}));
        }

        const classData = {
            1: {
                subjects: {
                    math: [
                        "Basic number recognition",
                        "Single-digit Addition",
                        "Single-digit Subtraction",
                        "Simple shapes (Circle, Square, Triangle)",
                        "Place value (Ones, Tens)"
                    ],
                    hindi: {
                        "Reading Skills": [
                            "Swar aur Vyanjan Pehchaan",
                            "Akshar Gyaan",
                            "Shabd Padna",
                            "Chhote Vakya Padna",
                            "Chitra Dekhkar Padna"
                        ],
                        "Writing Skills": [
                            "Akshar Lekhan",
                            "Shabd Lekhan",
                            "Chhote Vakya Lekhan",
                            "Shuddh Lekhan"
                        ],
                        "Listening & Speaking": [
                            "Sun Kar Dohrana",
                            "Kavita/Song Sunana",
                            "Chitra Varnan"
                        ],
                        "Vocabulary": ["Naye Shabd Seekhna"]
                    },
                    english: {
                        "Reading Skills": [
                            "Alphabet Recognition",
                            "Phonics & Sound Recognition",
                            "Simple Word Reading",
                            "Simple Sentence Reading",
                            "Picture Reading"
                        ],
                        "Writing Skills": [
                            "Capital & Small Letter Writing",
                            "Word Writing",
                            "Simple Sentence Writing"
                        ],
                        "Listening & Speaking": [
                            "Listening to Stories/Rhymes",
                            "Repeating Words/Sentences"
                        ],
                        "Vocabulary & Spelling": ["New Words", "Spelling Tests"]
                    }
                }
            },
            2: {
                subjects: {
                    math: [
                        "Single-digit Multiplication",
                        "Single-digit Division",
                        "Multi-digit Addition & Subtraction",
                        "More shapes (Rectangle, Oval, Semi-circle)",
                        "Place value (Hundreds)",
                        "Introduction to Measurement (Length: cm, m)"
                    ],
                    hindi: {
                        "Reading Skills": [
                            "Swar aur Vyanjan Pehchaan",
                            "Akshar Gyaan",
                            "Shabd Padna",
                            "Chhote Vakya Padna",
                            "Chitra Dekhkar Padna"
                        ],
                        "Writing Skills": [
                            "Akshar Lekhan",
                            "Shabd Lekhan",
                            "Chhote Vakya Lekhan",
                            "Shuddh Lekhan"
                        ],
                        "Listening & Speaking": [
                            "Sun Kar Dohrana",
                            "Kavita/Song Sunana",
                            "Chitra Varnan"
                        ],
                        "Vocabulary": ["Naye Shabd Seekhna"]
                    },
                    english: {
                        "Reading Skills": [
                            "Alphabet Recognition",
                            "Phonics & Sound Recognition",
                            "Simple Word Reading",
                            "Simple Sentence Reading",
                            "Picture Reading"
                        ],
                        "Writing Skills": [
                            "Capital & Small Letter Writing",
                            "Word Writing",
                            "Simple Sentence Writing"
                        ],
                        "Listening & Speaking": [
                            "Listening to Stories/Rhymes",
                            "Repeating Words/Sentences"
                        ],
                        "Vocabulary & Spelling": ["New Words", "Spelling Tests"]
                    }
                }
            },
            3: {
                subjects: {
                    math: [
                        "Multi-digit Multiplication",
                        "Multi-digit Division",
                        "Place value (Thousands)",
                        "Simple Fractions (1/2, 1/4, 3/4)",
                        "Roman Numbers",
                        "Introduction to Decimals (Tenths)",
                        "LCM & HCF",
                        "Measurement units (cm, m, g, kg, l)",
                        "Basic geometry (Lines, Angles, Corners)"
                    ],
                    hindi: {
                        "Reading Skills": [
                            "Shabd aur Vakya Padna",
                            "Kahani Padna",
                            "Gadyansh Padna"
                        ],
                        "Writing Skills": [
                            "Vakya Banana",
                            "Chitra Varnan",
                            "Anuchhed Lekhan"
                        ],
                        "Listening & Speaking": ["Kahani Sunana", "Samvaad"],
                        "Grammar": ["Sangya", "Sarvanam", "Ling", "Vachan"],
                        "Vocabulary & Dictation": [
                            "Shabd Gyaan",
                            "Shabd Shuddhi",
                            "Shrutlekh"
                        ]
                    },
                    english: {
                        "Reading Skills": [
                            "Short Story Reading",
                            "Simple Passage Reading",
                            "Fluency Practice"
                        ],
                        "Writing Skills": [
                            "Sentence Formation",
                            "Picture Composition",
                            "Short Paragraph Writing"
                        ],
                        "Listening & Speaking": ["Story Retelling", "Simple Dialogues"],
                        "Grammar": ["Noun", "Pronoun (Introduction)", "Singular/Plural"],
                        "Spelling & Dictation": ["Dictation", "Spelling Practice"]
                    },
                    evs: [
                        "चाचा की शादी",
                        "हमारा परिवार",
                        "जीव-जन्तुओं की दुनिया",
                        "रंग-बिरंगे पंख",
                        "पेड़-पौधों से दोस्ती",
                        "पता हूँ मैं हरा-हरा",
                        "तरह-तरह के भोजन",
                        "कुछ कच्चा कुछ पका हुआ",
                        "पकायेंगे-खायेंगे",
                        "घर को जानें",
                        "दीपावली की तैयारी",
                        "पुनरावृत्ति एवं अर्द्धवार्षिक",
                        "किस ओर क्या",
                        "स्कूल के आस-पास",
                        "पानी",
                        "दानापुर से गौरा तक",
                        "चिट्ठी का सफर",
                        "कपड़े तरह-तरह के",
                        "तेरी-मेरी उछलकूद",
                        "कोशिश करके देख ले",
                        "आओ खेलें मिट्टी से",
                        "पुनरावृत्ति एवं वार्षिक मूल्यांकन"
                    ]
                }
            },
            4: {
                subjects: {
                    math: [
                        "Fractions & Decimals (Addition/Subtraction)",
                        "Measurement units (Milli, Centi, Deca, etc.)",
                        "LCM & HCF",
                        "Basic Percentage",
                        "Roman Numbers",
                        "Advanced Place Value (Ten thousands, Lakhs)",
                        "Expanded form",
                        "Short form",
                        "Introduction to Algebraic concepts (Simple patterns)"
                    ],
                    hindi: {
                        "Reading Skills": ["Kahani/Kavita Padna", "Gadyansh Padna"],
                        "Writing Skills": [
                            "Patra Lekhan",
                            "Anuchhed Lekhan",
                            "Chitra Varnan"
                        ],
                        "Listening & Speaking": ["Samvaad", "Kavita Vachan"],
                        "Grammar": [
                            "Sangya",
                            "Sarvanam",
                            "Visheshan",
                            "Kriya",
                            "Ling",
                            "Vachan"
                        ],
                        "Vocabulary": ["Vilom", "Samanarthi", "Muhavare (basic only)"]
                    },
                    english: {
                        "Reading Skills": [
                            "Stories/Poems Reading",
                            "Simple Passage Comprehension"
                        ],
                        "Writing Skills": [
                            "Letter Writing (Simple, informal)",
                            "Paragraph Writing",
                            "Picture Composition"
                        ],
                        "Listening & Speaking": [
                            "Story Retelling",
                            "Simple Oral Presentation"
                        ],
                        "Grammar": [
                            "Noun",
                            "Pronoun",
                            "Verb",
                            "Adjective",
                            "Simple Tenses (Present/Past)",
                            "Sentence Formation"
                        ],
                        "Vocabulary": ["Synonyms/Antonyms (Basic)"]
                    },
                    evs: [
                        "रंग-बिरंगे खिलते फूल",
                        "कोई देता अंडे, कोई देता बच्चे",
                        "हड़बड़ में गड़बड़",
                        "त्योहार और भोजन",
                        "स्वाद अलग-अलग",
                        "हरियाली और हम",
                        "जड़ों की पकड़",
                        "देख तमाशा",
                        "जब मामाजी घर आए",
                        "छठ पर्व और बच्चे",
                        "आओ बनाएं नक्शा",
                        "अपना प्यारा घर",
                        "खेत से घर तक",
                        "पुनरावृत्ति एवं अर्द्धवार्षिक",
                        "बालमेला और खेल",
                        "आस-पास की सफाई",
                        "मीठा-मीठा शहद",
                        "तरह-तरह के पक्षी",
                        "जंगल में पिकनिक",
                        "ककोलत से कन्याकुमारी",
                        "हमारे मददगार-कामगार",
                        "तरह-तरह के घर",
                        "अजय जब गाँव लौटे",
                        "आस-पास की खोज खबर",
                        "बिच्छीघर की सैर",
                        "बंटी का सफर",
                        "पुनरावृत्ति एवं वार्षिक मूल्यांकन"
                    ]
                }
            },
            5: {
                subjects: {
                    math: [
                        "Fractions & Decimals (Multiplication/Division)",
                        "Advanced Percentage",
                        "Measurement units (Milli, Centi, Deca, etc.)",
                        "Ratio & Proportion",
                        "Profit & Loss",
                        "Square & Square Root",
                        "Binary System",
                        "More on Algebraic concepts (Simple equations)"
                    ],
                    hindi: {
                        "Reading Skills": ["Kahani/Kavita Padna", "Gadyansh Padna"],
                        "Writing Skills": [
                            "Patra Lekhan",
                            "Anuchhed Lekhan",
                            "Chitra Varnan"
                        ],
                        "Listening & Speaking": ["Samvaad", "Kavita Vachan"],
                        "Grammar": [
                            "Sangya",
                            "Sarvanam",
                            "Visheshan",
                            "Kriya",
                            "Ling",
                            "Vachan"
                        ],
                        "Vocabulary": ["Vilom", "Samanarthi", "Muhavare (basic only)"]
                    },
                    english: {
                        "Reading Skills": [
                            "Stories/Poems Reading",
                            "Simple Passage Comprehension"
                        ],
                        "Writing Skills": [
                            "Letter Writing (Simple, informal)",
                            "Paragraph Writing",
                            "Picture Composition"
                        ],
                        "Listening & Speaking": [
                            "Story Retelling",
                            "Simple Oral Presentation"
                        ],
                        "Grammar": [
                            "Noun",
                            "Pronoun",
                            "Verb",
                            "Adjective",
                            "Simple Tenses (Present/Past)",
                            "Sentence Formation"
                        ],
                        "Vocabulary": ["Synonyms/Antonyms (Basic)"]
                    },
                    evs: [
                        "पटना से नाथुला की यात्रा",
                        "खेल",
                        "बीजों का बिखरना",
                        "मेरा बग़ीचा",
                        "ऐतिहासिक स्मारक",
                        "सिंचाई के साधन",
                        "जितना खाओ उतना पकाओ",
                        "रॉस की जंग : मच्छरों के संग",
                        "मैंने नक्शा बनाया",
                        "हमारी फसलें : हमारा खान-पान",
                        "पुनरावृत्ति एवं अर्द्धवार्षिक मूल्यांकन",
                        "जंतु जगत : सुरक्षा और संरक्षण",
                        "मान गए लोहा",
                        "पानी और हम",
                        "सूरज एक काम अनेक",
                        "हमारा जंगल",
                        "चलो सर्वे करें",
                        "राम काका की दुकान",
                        "आवास",
                        "तरह-तरह के व्यवसाय",
                        "रायपुर वाले च policemen की शादी",
                        "लकी जब बीमार पड़ा",
                        "पुनरावृत्ति एवं वार्षिक मूल्यांकन"
                    ]
                }
            }
        };

        const statusLevels = [
            { name: "At Risk", class: "badge-at-risk", minProgress: 0, maxProgress: 19 },
            { name: "Not Started", class: "badge-not-started", minProgress: 0, maxProgress: 0 },
            { name: "Needs Improvement", class: "badge-needs-improvement", minProgress: 20, maxProgress: 39 },
            { name: "Practicing", class: "badge-practicing", minProgress: 40, maxProgress: 59 },
            { name: "Satisfactory", class: "badge-satisfactory", minProgress: 60, maxProgress: 79 },
            { name: "Mastered", class: "badge-mastered", minProgress: 80, maxProgress: 100 }
        ];

        // DOM Elements
        const loginPage = document.getElementById("login-page");
        const dashboard = document.getElementById("dashboard");
        const adminSchoolManagement = document.getElementById("admin-school-management");
        const adminTeacherManagement = document.getElementById("admin-teacher-management");
        const teacherDashboard = document.getElementById("teacher-dashboard");
        const loginBtn = document.getElementById("login-btn");
        const logoutBtn = document.getElementById("logout-btn");
        const loginError = document.getElementById("login-error");
        const schoolNameSelect = document.getElementById("school-name");
        const schoolNameError = document.getElementById("school-name-error");
        const switchSchoolBtn = document.getElementById("switch-school-btn");
        const exportDataBtn = document.getElementById("export-data-btn");
        const importDataBtn = document.getElementById("import-data-btn");
        const importDataInput = document.getElementById("import-data-input");
        const classSelect = document.getElementById("class-select");
        const addStudentBtn = document.getElementById("add-student-btn");
        const studentList = document.getElementById("student-list");
        const addTeacherBtn = document.getElementById("add-teacher-btn");
        const teacherList = document.getElementById("teacher-list");
        const teacherSchoolSelect = document.getElementById("teacher-school-select");
        const addSchoolBtn = document.getElementById("add-school-btn");
        const schoolList = document.getElementById("school-list");
        const welcomeMessage = document.getElementById("welcome-message");
        const modal = document.getElementById("student-progress-modal");
        const modalSubjectsContainer = document.getElementById("modal-subjects-container");
        const updateStudentProgressBtn = document.getElementById("update-student-progress-btn");
        const updateHistory = document.getElementById("update-history");
        const closeModal = document.querySelector(".close-modal");
        const schoolManagementNav = document.getElementById("school-management-nav");
        const teacherManagementNav = document.getElementById("teacher-management-nav");
        const topNav = document.getElementById("top-nav");

        let progressChart;
        let studentProgressChart;
        let currentStudentId;
        let currentStudentClass;

        // School name validation
        function validateSchoolName(name) {
            const regex = /^[a-zA-Z0-9\s-]+$/;
            return regex.test(name);
        }

        // Initialize school data if none exists
        function initializeSchoolData(schoolName) {
            if (!localStorage.getItem(`${schoolName}_students`)) {
                localStorage.setItem(`${schoolName}_students`, JSON.stringify([]));
            }
            if (!localStorage.getItem(`${schoolName}_teachers`)) {
                localStorage.setItem(`${schoolName}_teachers`, JSON.stringify([]));
            }
            if (!localStorage.getItem(`${schoolName}_studentProgress`)) {
                localStorage.setItem(`${schoolName}_studentProgress`, JSON.stringify({}));
            }
        }

        // Populate school dropdown
        function populateSchoolDropdown(elementId) {
            const schoolAccessList = JSON.parse(localStorage.getItem("schoolAccessList")) || {};
            const selectElement = document.getElementById(elementId);
            selectElement.innerHTML = '<option value="" disabled selected>Select School</option>';
            Object.keys(schoolAccessList).forEach(school => {
                const option = document.createElement("option");
                option.value = school;
                option.textContent = school;
                selectElement.appendChild(option);
            });
        }

        // Initial population of school dropdowns
        populateSchoolDropdown("school-name");
        populateSchoolDropdown("teacher-school-select");

        // Login Handler
        loginBtn.addEventListener("click", () => {
            const schoolName = schoolNameSelect.value;
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;

            const schoolAccessList = JSON.parse(localStorage.getItem("schoolAccessList")) || {};
            const isAdmin = username === adminCredentials.username && password === adminCredentials.password;

            if (isAdmin) {
                currentRole = "admin";
                if (!schoolName || !schoolAccessList[schoolName]) {
                    const defaultSchool = "Default School";
                    if (!schoolAccessList[defaultSchool]) {
                        schoolAccessList[defaultSchool] = {};
                        localStorage.setItem("schoolAccessList", JSON.stringify(schoolAccessList));
                        populateSchoolDropdown("school-name");
                        populateSchoolDropdown("teacher-school-select");
                    }
                    currentSchool = defaultSchool;
                } else {
                    currentSchool = schoolName;
                }
                localStorage.setItem("currentSchool", currentSchool);
                initializeSchoolData(currentSchool);

                loginPage.classList.add("hidden");
                dashboard.classList.remove("hidden");
                topNav.classList.remove("hidden");
                if (Object.keys(schoolAccessList).length === 1 && schoolAccessList["Default School"]) {
                    welcomeMessage.classList.remove("hidden");
                    adminSchoolManagement.classList.remove("hidden");
                    teacherDashboard.classList.add("hidden");
                    adminTeacherManagement.classList.add("hidden");
                } else {
                    welcomeMessage.classList.add("hidden");
                    adminSchoolManagement.classList.remove("hidden");
                    adminTeacherManagement.classList.add("hidden");
                    teacherDashboard.classList.add("hidden");
                    loadSchoolManagement();
                }
                exportDataBtn.classList.remove("hidden");
                importDataBtn.classList.remove("hidden");
            } else {
                if (!schoolName || !schoolAccessList[schoolName]) {
                    schoolNameError.textContent = "Please select a school.";
                    schoolNameError.classList.remove("hidden");
                    return;
                }
                schoolNameError.classList.add("hidden");

                currentSchool = schoolName;
                localStorage.setItem("currentSchool", currentSchool);
                initializeSchoolData(currentSchool);

                const teachers = JSON.parse(localStorage.getItem(`${currentSchool}_teachers`)) || [];
                const teacher = teachers.find(t => t.username === username && t.password === password);
                if (teacher) {
                    currentRole = "teacher";
                    loginPage.classList.add("hidden");
                    dashboard.classList.remove("hidden");
                    topNav.classList.add("hidden");
                    teacherDashboard.classList.remove("hidden");
                    loadStudents();
                    exportDataBtn.classList.add("hidden");
                    importDataBtn.classList.add("hidden");
                } else {
                    loginError.textContent = "Invalid credentials for this school.";
                    loginError.classList.remove("hidden");
                }
            }
        });

        // Logout Handler
        logoutBtn.addEventListener("click", () => {
            loginPage.classList.remove("hidden");
            dashboard.classList.add("hidden");
            adminSchoolManagement.classList.add("hidden");
            adminTeacherManagement.classList.add("hidden");
            teacherDashboard.classList.add("hidden");
            loginError.classList.add("hidden");
            document.getElementById("username").value = "";
            document.getElementById("password").value = "";
            schoolNameSelect.value = "";
            currentRole = "";
            currentSchool = "";
            localStorage.removeItem("currentSchool");
        });

        // Switch School Handler
        switchSchoolBtn.addEventListener("click", () => {
            loginPage.classList.remove("hidden");
            dashboard.classList.add("hidden");
            adminSchoolManagement.classList.add("hidden");
            adminTeacherManagement.classList.add("hidden");
            teacherDashboard.classList.add("hidden");
            schoolNameSelect.value = "";
            document.getElementById("username").value = "";
            document.getElementById("password").value = "";
            currentRole = "";
            currentSchool = "";
            localStorage.removeItem("currentSchool");
        });

        // Export Data Handler
        exportDataBtn.addEventListener("click", () => {
            const schoolData = {
                students: JSON.parse(localStorage.getItem(`${currentSchool}_students`)) || [],
                teachers: JSON.parse(localStorage.getItem(`${currentSchool}_teachers`)) || [],
                studentProgress: JSON.parse(localStorage.getItem(`${currentSchool}_studentProgress`)) || {}
            };
            const dataStr = JSON.stringify(schoolData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `${currentSchool}_data.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // Import Data Handler
        importDataInput.addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData.students && importedData.teachers && importedData.studentProgress) {
                            localStorage.setItem(`${currentSchool}_students`, JSON.stringify(importedData.students));
                            localStorage.setItem(`${currentSchool}_teachers`, JSON.stringify(importedData.teachers));
                            localStorage.setItem(`${currentSchool}_studentProgress`, JSON.stringify(importedData.studentProgress));
                            alert("Data imported successfully!");
                            loadTeachers();
                            loadStudents();
                        } else {
                            alert("Invalid data format. Please ensure the file contains students, teachers, and studentProgress.");
                        }
                    } catch (err) {
                        alert("Error importing data. Please ensure the file is a valid JSON.");
                    }
                };
                reader.readAsText(file);
            }
        });

        // Admin Navigation
        schoolManagementNav.addEventListener("click", () => {
            adminSchoolManagement.classList.remove("hidden");
            adminTeacherManagement.classList.add("hidden");
            teacherDashboard.classList.add("hidden");
            welcomeMessage.classList.add("hidden");
            loadSchoolManagement();
        });

        teacherManagementNav.addEventListener("click", () => {
            adminSchoolManagement.classList.add("hidden");
            adminTeacherManagement.classList.remove("hidden");
            teacherDashboard.classList.add("hidden");
            welcomeMessage.classList.add("hidden");
            loadTeachers();
        });

        // School Management
        function loadSchoolManagement() {
            schoolList.innerHTML = "";
            const schoolAccessList = JSON.parse(localStorage.getItem("schoolAccessList")) || {};

            for (const schoolName of Object.keys(schoolAccessList)) {
                const schoolCard = document.createElement("div");
                schoolCard.className = "bg-gray-100 p-4 rounded-lg flex justify-between items-center mb-2";
                schoolCard.innerHTML = `
                    <span>${schoolName}</span>
                    <button class="remove-school-btn bg-red-500 text-white px-2 py-1 rounded-lg hover:bg-red-600" data-school="${schoolName}">Remove</button>
                `;
                schoolList.appendChild(schoolCard);
            }

            document.querySelectorAll(".remove-school-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const schoolName = btn.dataset.school;
                    if (confirm(`Are you sure you want to remove ${schoolName}? This will delete all associated data.`)) {
                        const schoolAccessList = JSON.parse(localStorage.getItem("schoolAccessList")) || {};
                        delete schoolAccessList[schoolName];
                        localStorage.setItem("schoolAccessList", JSON.stringify(schoolAccessList));
                        localStorage.removeItem(`${schoolName}_students`);
                        localStorage.removeItem(`${schoolName}_teachers`);
                        localStorage.removeItem(`${schoolName}_studentProgress`);
                        loadSchoolManagement();
                        populateSchoolDropdown("school-name");
                        populateSchoolDropdown("teacher-school-select");
                    }
                });
            });
        }

        addSchoolBtn.addEventListener("click", () => {
            const schoolName = document.getElementById("new-school-name").value.trim();
            const schoolAccessList = JSON.parse(localStorage.getItem("schoolAccessList")) || {};

            if (schoolName && validateSchoolName(schoolName)) {
                if (schoolAccessList[schoolName]) {
                    alert("School already exists!");
                    return;
                }
                schoolAccessList[schoolName] = {};
                localStorage.setItem("schoolAccessList", JSON.stringify(schoolAccessList));
                document.getElementById("new-school-name").value = "";
                loadSchoolManagement();
                populateSchoolDropdown("school-name");
                populateSchoolDropdown("teacher-school-select");
            } else {
                alert("Please enter a valid school name (letters, numbers, spaces, and hyphens only).");
            }
        });

        // Teacher Management
        function loadTeachers() {
            teacherList.innerHTML = "";
            const schoolAccessList = JSON.parse(localStorage.getItem("schoolAccessList")) || {};
            const selectedSchool = teacherSchoolSelect.value || Object.keys(schoolAccessList)[0];
            if (!selectedSchool) return;

            const teachers = JSON.parse(localStorage.getItem(`${selectedSchool}_teachers`)) || [];
            teachers.forEach(teacher => {
                const teacherCard = document.createElement("div");
                teacherCard.className = "bg-gray-100 p-4 rounded-lg flex justify-between items-center";
                teacherCard.innerHTML = `
                    <span>${teacher.username} (School: ${selectedSchool})</span>
                    <button class="bg-red-500 text-white px-2 py-1 rounded-lg hover:bg-red-600 remove-teacher-btn" data-username="${teacher.username}" data-school="${selectedSchool}">Remove</button>
                `;
                teacherList.appendChild(teacherCard);
            });

            document.querySelectorAll(".remove-teacher-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const username = btn.dataset.username;
                    const school = btn.dataset.school;
                    let teachers = JSON.parse(localStorage.getItem(`${school}_teachers`)) || [];
                    teachers = teachers.filter(t => t.username !== username);
                    localStorage.setItem(`${school}_teachers`, JSON.stringify(teachers));
                    loadTeachers();
                });
            });
        }

        addTeacherBtn.addEventListener("click", () => {
            const selectedSchool = teacherSchoolSelect.value;
            const username = document.getElementById("teacher-username").value;
            const password = document.getElementById("teacher-password").value;

            if (!selectedSchool) {
                alert("Please select a school.");
                return;
            }
            if (username && password) {
                let teachers = JSON.parse(localStorage.getItem(`${selectedSchool}_teachers`)) || [];
                if (!teachers.find(t => t.username === username)) {
                    teachers.push({ username, password });
                    localStorage.setItem(`${selectedSchool}_teachers`, JSON.stringify(teachers));
                    loadTeachers();
                    document.getElementById("teacher-username").value = "";
                    document.getElementById("teacher-password").value = "";
                } else {
                    alert("Teacher username already exists in this school!");
                }
            } else {
                alert("Please enter both username and password.");
            }
        });

        teacherSchoolSelect.addEventListener("change", () => {
            loadTeachers();
        });

        // Student Management
        function loadStudents() {
            studentList.innerHTML = "";
            const selectedClass = classSelect.value;
            if (!selectedClass) {
                studentList.innerHTML = "<p class='text-gray-600'>Please select a class to view students.</p>";
                return;
            }
            let students = JSON.parse(localStorage.getItem(`${currentSchool}_students`)) || [];
            if (!Array.isArray(students)) {
                students = [];
                localStorage.setItem(`${currentSchool}_students`, JSON.stringify(students));
            }
            const filteredStudents = students.filter(student => student.classId === selectedClass);
            filteredStudents.forEach(student => {
                const isAtRisk = checkAtRisk(student.id, selectedClass);
                const studentCard = document.createElement("div");
                studentCard.className = `bg-white p-4 rounded-lg shadow-md cursor-pointer hover:bg-gray-100 transition ${isAtRisk ? "at-risk" : ""}`;
                studentCard.dataset.studentId = student.id;
                const lastUpdate = getLastUpdate(student.id);
                studentCard.innerHTML = `
                    <div class="relative">
                        <button class="delete-student-btn absolute top-0 right-0 text-sm px-2 py-1 rounded-lg bg-red-500 text-white hover:bg-red-600" data-student-id="${student.id}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        <img src="${student.photo || 'https://via.placeholder.com/100'}" alt="${student.name}" class="w-24 h-24 rounded-full mx-auto mb-4">
                        <h3 class="text-lg font-medium">${student.name}</h3>
                        <p class="text-gray-600">Roll: ${student.roll}</p>
                        <p class="text-gray-600">Class: ${student.classId}</p>
                        <p class="text-sm text-gray-500">Last Updated: ${lastUpdate || 'Never'}</p>
                        ${isAtRisk ? '<span class="badge badge-at-risk mt-2 inline-block">At Risk</span>' : ''}
                    </div>
                `;
                studentCard.addEventListener("click", (e) => {
                    if (!e.target.classList.contains("delete-student-btn") && !e.target.closest(".delete-student-btn")) {
                        showStudentProgress(student.id, student.name, student.classId);
                    }
                });
                studentList.appendChild(studentCard);
            });

            document.querySelectorAll(".delete-student-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const studentId = btn.dataset.studentId;
                    if (window.confirm("Are you sure you want to delete this student?")) {
                        deleteStudent(studentId);
                    }
                });
            });

            updateClassProgressChart();
        }

        function deleteStudent(studentId) {
            let students = JSON.parse(localStorage.getItem(`${currentSchool}_students`)) || [];
            students = students.filter(student => student.id !== studentId);

            let studentProgress = JSON.parse(localStorage.getItem(`${currentSchool}_studentProgress`)) || {};
            if (studentProgress[studentId]) {
                delete studentProgress[studentId];
                localStorage.setItem(`${currentSchool}_studentProgress`, JSON.stringify(studentProgress));
            }

            localStorage.setItem(`${currentSchool}_students`, JSON.stringify(students));
            loadStudents();
        }

        function checkAtRisk(studentId, classId) {
            const studentProgress = JSON.parse(localStorage.getItem(`${currentSchool}_studentProgress`)) || {};
            const progress = studentProgress[studentId]?.[classId];
            if (!progress) return true;
            const subjects = Object.keys(classData[classId].subjects);
            const totalProgress = subjects.reduce((sum, subject) => sum + (progress[subject]?.percentage || 0), 0);
            const avgProgress = subjects.length > 0 ? totalProgress / subjects.length : 0;
            return avgProgress >= 0 && avgProgress <= 19;
        }

        function getLastUpdate(studentId) {
            const studentProgress = JSON.parse(localStorage.getItem(`${currentSchool}_studentProgress`)) || {};
            const progress = studentProgress[studentId];
            if (!progress) return null;
            let latestDate = null;
            for (const classId in progress) {
                for (const subject in progress[classId]) {
                    const date = progress[classId][subject].lastUpdated;
                    if (date && (!latestDate || new Date(date) > new Date(latestDate))) {
                        latestDate = date;
                    }
                }
            }
            return latestDate;
        }

        addStudentBtn.addEventListener("click", () => {
            const name = document.getElementById("student-name").value;
            const roll = document.getElementById("student-roll").value;
            const classId = document.getElementById("student-class").value;
            const photoInput = document.getElementById("student-photo");

            if (name && roll && classId) {
                let students = JSON.parse(localStorage.getItem(`${currentSchool}_students`)) || [];
                if (!Array.isArray(students)) {
                    students = [];
                }
                if (students.find(s => s.roll === roll && s.classId === classId)) {
                    alert("Student with this roll number already exists in this class!");
                    return;
                }
                const reader = new FileReader();
                reader.onload = () => {
                    students.push({
                        id: `${classId}-${roll}`,
                        name,
                        roll,
                        classId,
                        photo: photoInput.files[0] ? reader.result : null
                    });
                    localStorage.setItem(`${currentSchool}_students`, JSON.stringify(students));
                    loadStudents();
                    document.getElementById("student-name").value = "";
                    document.getElementById("student-roll").value = "";
                    document.getElementById("student-class").value = "";
                    document.getElementById("student-photo").value = "";
                };
                if (photoInput.files[0]) {
                    reader.readAsDataURL(photoInput.files[0]);
                } else {
                    reader.onload();
                }
            } else {
                alert("Please fill all fields, including class.");
            }
        });

        // Student Progress Modal
        function showStudentProgress(studentId, studentName, classId) {
            currentStudentId = studentId;
            currentStudentClass = classId;
            document.getElementById("modal-student-name").textContent = `${studentName}'s Progress`;
            modal.style.display = "block";
            updateStudentSubjects(classId);
            updateStudentProgressChart();
            updateHistoryDisplay();
        }

        closeModal.addEventListener("click", () => {
            modal.style.display = "none";
            if (studentProgressChart) {
                studentProgressChart.destroy();
            }
        });

        modal.addEventListener("click", (e) => {
            if (e.target === modal) {
                modal.style.display = "none";
                if (studentProgressChart) {
                    studentProgressChart.destroy();
                }
            }
        });

        function createSubjectDiv(subject) {
            const subjectDiv = document.createElement("div");
            subjectDiv.className = "bg-white p-6 rounded-lg shadow-md subject-card";
            subjectDiv.dataset.subject = subject;

            const subjectTitle = document.createElement("h2");
            subjectTitle.className = "text-2xl font-semibold mb-4 flex items-center text-indigo-600";
            const icon = document.createElement("i");
            const iconClass = subject === "math" ? "fa-calculator" : 
                             subject === "hindi" ? "fa-language" : 
                             subject === "english" ? "fa-book" : "fa-leaf";
            icon.className = `fas ${iconClass} mr-2 text-indigo-500`;
            subjectTitle.appendChild(icon);
            subjectTitle.appendChild(document.createTextNode(subject.charAt(0).toUpperCase() + subject.slice(1)));
            subjectDiv.appendChild(subjectTitle);

            const badgeDiv = document.createElement("div");
            badgeDiv.className = "mb-4";
            const badge = document.createElement("span");
            badge.className = "badge badge-not-started";
            badge.textContent = "Not Started";
            badgeDiv.appendChild(badge);
            subjectDiv.appendChild(badgeDiv);

            const progressDiv = document.createElement("div");
            progressDiv.className = "progress-circle mb-4";
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("width", "60");
            svg.setAttribute("height", "60");
            const circleBg = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            circleBg.className = "circle-bg";
            circleBg.setAttribute("cx", "30");
            circleBg.setAttribute("cy", "30");
            circleBg.setAttribute("r", "25");
            const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            circle.className = "circle";
            circle.setAttribute("cx", "30");
            circle.setAttribute("cy", "30");
            circle.setAttribute("r", "25");
            circle.setAttribute("stroke-dasharray", "157");
            circle.setAttribute("stroke-dashoffset", "157");
            svg.appendChild(circleBg);
            svg.appendChild(circle);
            const percentageDiv = document.createElement("div");
            percentageDiv.className = "percentage";
            percentageDiv.textContent = "0%";
            progressDiv.appendChild(svg);
            progressDiv.appendChild(percentageDiv);
            subjectDiv.appendChild(progressDiv);

            const topicsHeader = document.createElement("h3");
            topicsHeader.className = "text-xl font-medium mb-2 text-indigo-600";
            topicsHeader.textContent = "Topics";
            subjectDiv.appendChild(topicsHeader);

            const topicsList = document.createElement("ul");
            topicsList.className = "space-y-2";
            subjectDiv.appendChild(topicsList);

            return subjectDiv;
        }

        function updateStudentSubjects(classId) {
            modalSubjectsContainer.innerHTML = "";
            const subjects = classData[classId].subjects;
            const studentProgress = JSON.parse(localStorage.getItem(`${currentSchool}_studentProgress`)) || {};
            const studentData = studentProgress[currentStudentId] || {};

            for (const [subject, topics] of Object.entries(subjects)) {
                const subjectDiv = createSubjectDiv(subject);
                const topicsList = subjectDiv.querySelector("ul");
                const savedProgress = studentData[classId]?.[subject]?.topics || [];

                if (typeof topics === "object" && !Array.isArray(topics)) {
                    for (const [section, sectionTopics] of Object.entries(topics)) {
                        const sectionHeader = document.createElement("li");
                        sectionHeader.className = "font-semibold text-lg mt-4 text-indigo-500";
                        sectionHeader.textContent = section;
                        topicsList.appendChild(sectionHeader);

                        sectionTopics.forEach((topic, index) => {
                            const li = document.createElement("li");
                            li.className = "flex items-center";
                            const isChecked = savedProgress.find(p => p.topic === topic)?.checked || false;
                            li.innerHTML = `<input type="checkbox" class="mr-2 topic-checkbox" data-topic="${topic}" data-weight="${sectionTopics.length - index}" ${isChecked ? "checked" : ""}><span>${topic}</span>`;
                            topicsList.appendChild(li);
                        });
                    }
                } else {
                    topics.forEach((topic, index) => {
                        const li = document.createElement("li");
                        li.className = "flex items-center";
                        const isChecked = savedProgress.find(p => p.topic === topic)?.checked || false;
                        li.innerHTML = `<input type="checkbox" class="mr-2 topic-checkbox" data-topic="${topic}" data-weight="${topics.length - index}" ${isChecked ? "checked" : ""}><span>${topic}</span>`;
                        topicsList.appendChild(li);
                    });
                }

                subjectDiv.querySelectorAll(".topic-checkbox").forEach(checkbox => {
                    checkbox.addEventListener("change", () => updateProgress(subjectDiv));
                });

                modalSubjectsContainer.appendChild(subjectDiv);
                updateProgress(subjectDiv);
            }
        }

        function updateProgress(subjectDiv) {
            const checkboxes = subjectDiv.querySelectorAll(".topic-checkbox");
            let totalWeight = 0;
            let checkedWeight = 0;

            checkboxes.forEach(checkbox => {
                const weight = parseInt(checkbox.dataset.weight);
                totalWeight += weight;
                if (checkbox.checked) {
                    checkedWeight += weight;
                }
            });

            const percentage = totalWeight > 0 ? (checkedWeight / totalWeight) * 100 : 0;

            const circle = subjectDiv.querySelector(".circle");
            if (circle) {
                const circumference = 157;
                const offset = circumference - (percentage / 100) * circumference;
                circle.setAttribute("stroke-dashoffset", offset);
            }

            const percentageText = subjectDiv.querySelector(".percentage");
            if (percentageText) {
                percentageText.textContent = `${Math.round(percentage)}%`;
            }

            const badge = subjectDiv.querySelector(".badge");
            if (badge) {
                let status = statusLevels[1];
                if (checkedWeight > 0) {
                    status = statusLevels.find(s => percentage >= s.minProgress && percentage <= s.maxProgress) || statusLevels[statusLevels.length - 1];
                }
                badge.textContent = status.name;
                badge.className = `badge ${status.class}`;
            }
        }

        updateStudentProgressBtn.addEventListener("click", () => {
            const classId = currentStudentClass;
            const subjects = modalSubjectsContainer.querySelectorAll(".subject-card");
            let studentProgress = JSON.parse(localStorage.getItem(`${currentSchool}_studentProgress`)) || {};
            if (!studentProgress[currentStudentId]) {
                studentProgress[currentStudentId] = {};
            }
            if (!studentProgress[currentStudentId][classId]) {
                studentProgress[currentStudentId][classId] = {};
            }

            subjects.forEach(subjectDiv => {
                const subject = subjectDiv.dataset.subject;
                const checkboxes = subjectDiv.querySelectorAll(".topic-checkbox");
                const percentageText = subjectDiv.querySelector(".percentage").textContent;
                const percentage = parseFloat(percentageText);
                const date = new Date().toLocaleDateString();

                const topics = Array.from(checkboxes).map(checkbox => ({
                    topic: checkbox.dataset.topic,
                    checked: checkbox.checked
                }));

                let history = studentProgress[currentStudentId][classId][subject]?.history || [];
                history.push({ percentage, date });

                studentProgress[currentStudentId][classId][subject] = {
                    topics,
                    percentage,
                    lastUpdated: date,
                    history
                };
            });

            localStorage.setItem(`${currentSchool}_studentProgress`, JSON.stringify(studentProgress));
            updateHistoryDisplay();
            updateStudentProgressChart();
            loadStudents();
            updateClassProgressChart();
        });

        function updateHistoryDisplay() {
            updateHistory.innerHTML = "";
            const studentProgress = JSON.parse(localStorage.getItem(`${currentSchool}_studentProgress`)) || {};
            const progress = studentProgress[currentStudentId]?.[currentStudentClass];
            if (!progress) {
                updateHistory.innerHTML = "<p>No updates yet.</p>";
                return;
            }

            const historyList = document.createElement("ul");
            historyList.className = "space-y-2";
            for (const [subject, data] of Object.entries(progress)) {
                if (data.lastUpdated) {
                    const li = document.createElement("li");
                    li.className = "text-gray-600";
                    li.textContent = `${subject.charAt(0).toUpperCase() + subject.slice(1)}: Updated on ${data.lastUpdated} (${data.percentage}%)`;
                    historyList.appendChild(li);
                }
            }
            updateHistory.appendChild(historyList);
        }

        function updateStudentProgressChart() {
            const studentProgress = JSON.parse(localStorage.getItem(`${currentSchool}_studentProgress`)) || {};
            const classId = currentStudentClass;
            const progress = studentProgress[currentStudentId]?.[classId] || {};
            const subjects = Object.keys(classData[classId].subjects);
            const datasets = subjects.map(subject => {
                const history = progress[subject]?.history || [{ percentage: 0, date: new Date().toLocaleDateString() }];
                return {
                    label: subject.charAt(0).toUpperCase() + subject.slice(1),
                    data: history.map(h => h.percentage || progress[subject]?.percentage || 0),
                    borderColor: getRandomColor(),
                    fill: false
                };
            });

            const labels = progress[subjects[0]]?.history?.map(h => h.date) || [new Date().toLocaleDateString()];

            if (studentProgressChart) {
                studentProgressChart.destroy();
            }

            studentProgressChart = new Chart(document.getElementById("studentProgressChartCanvas"), {
                type: 'line',
                data: {
                    labels,
                    datasets
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Progress (%)' }
                        },
                        x: { title: { display: true, text: 'Date' } }
                    }
                }
            });
        }

        function updateClassProgressChart() {
            const studentProgress = JSON.parse(localStorage.getItem(`${currentSchool}_studentProgress`)) || {};
            const classId = classSelect.value;
            if (!classId) return;
            const subjects = Object.keys(classData[classId].subjects);
            const students = JSON.parse(localStorage.getItem(`${currentSchool}_students`)) || [];
            const filteredStudents = students.filter(student => student.classId === classId);
            const datasets = subjects.map(subject => {
                const data = filteredStudents.map(student => {
                    const progress = studentProgress[student.id]?.[classId]?.[subject]?.percentage || 0;
                    return progress;
                });
                return {
                    label: subject.charAt(0).toUpperCase() + subject.slice(1),
                    data,
                    borderColor: getRandomColor(),
                    fill: false
                };
            });

            const labels = filteredStudents.map(student => student.name);

            if (progressChart) {
                progressChart.destroy();
            }

            progressChart = new Chart(document.getElementById("progressChartCanvas"), {
                type: 'line',
                data: {
                    labels,
                    datasets
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Progress (%)' }
                        },
                        x: { title: { display: true, text: 'Student' } }
                    }
                }
            });
        }

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        classSelect.addEventListener("change", () => loadStudents());
    </script>
</body>
</html>